name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 1.0.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  validate:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
    steps:
      - name: Validate version format
        id: validate
        run: |
          VERSION="${{ inputs.version }}"
          if ! echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Invalid version '$VERSION'. Must match semver pattern (e.g. 1.0.0)"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "::notice::Version validated: v$VERSION"

  release-ci:
    name: Release CI
    needs: validate
    uses: ./.github/workflows/release-ci.yml
    with:
      version: ${{ needs.validate.outputs.version }}

  approval:
    name: Manual Approval
    needs: release-ci
    runs-on: ubuntu-latest
    environment: release
    steps:
      - name: Approval gate passed
        run: |
          echo "::notice::Release v${{ needs.validate.outputs.version }} approved by reviewer"

  release:
    name: Create Release
    needs: [validate, approval]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge develop into main
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          # Checkout main and ensure it's up to date
          git checkout main
          git pull origin main
          
          # Check if develop has new commits
          BEHIND=$(git rev-list --count main..develop)
          if [ "$BEHIND" -eq 0 ]; then
            echo "::error::develop has no new commits to release"
            exit 1
          fi
          
          # Merge develop into main (fast-forward for linear history)
          git merge develop --ff-only
          git push origin main
          
          echo "::notice::Merged develop into main for v$VERSION"

      - name: Create tag
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"
          echo "::notice::Created tag v$VERSION"

      - name: Create GitHub Release
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          gh release create "v$VERSION" \
            --target main \
            --title "v$VERSION" \
            --generate-notes
          echo "::notice::Created GitHub Release v$VERSION"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}