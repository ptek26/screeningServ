name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 1.0.0)"
        required: true
        type: string
      dry_run:
        description: "Dry run — create PR but don't auto-merge"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version
        run: |
          if ! echo "${{ inputs.version }}" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Invalid version '${{ inputs.version }}'. Must match semver pattern (e.g. 1.0.0)"
            exit 1
          fi

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create release branch
        run: |
          git checkout develop
          git pull origin develop
          git checkout -b release/v${{ inputs.version }}
          git push origin release/v${{ inputs.version }}

      - name: Ensure release label exists
        run: gh label create release --color 0E8A16 --description "Release PR" || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create pull request
        id: create-pr
        run: |
          PR_URL=$(gh pr create \
            --base main \
            --head release/v${{ inputs.version }} \
            --title "Release v${{ inputs.version }}" \
            --body "## Release v${{ inputs.version }}

          Automated release PR from \`develop\` → \`main\`.

          Triggered by: @${{ github.actor }}" \
            --label release)
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        if: inputs.dry_run == false
        run: |
          gh pr merge --auto --squash "${{ steps.create-pr.outputs.pr_url }}"
          echo "::notice::PR created and auto-merge enabled. Tag will be created automatically when the PR merges."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
